<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L'Art du Trading</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%); color: #fff; min-height: 100vh; padding: 24px; }
        .container { max-width: 1400px; margin: 0 auto; }
        .login-container { display: flex; align-items: center; justify-content: center; min-height: 100vh; }
        .login-box { background: #334155; border: 1px solid #475569; border-radius: 8px; padding: 40px; text-align: center; max-width: 400px; }
        .login-box h1 { font-size: 28px; margin-bottom: 8px; background: linear-gradient(90deg, #60a5fa, #22d3ee); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .login-box p { color: #94a3b8; margin-bottom: 24px; }
        .login-box input { width: 100%; padding: 12px; margin-bottom: 16px; background: #475569; border: 1px solid #334155; color: white; border-radius: 6px; font-size: 14px; }
        .login-box input:focus { outline: none; border-color: #3b82f6; }
        .login-box button { width: 100%; padding: 12px; background: #16a34a; color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 14px; }
        .login-box button:hover { background: #15803d; }
        h1 { font-size: 36px; font-weight: bold; margin-bottom: 4px; background: linear-gradient(90deg, #60a5fa, #22d3ee); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .subtitle { color: #94a3b8; margin-bottom: 24px; font-size: 14px; }
        .header { border-bottom: 1px solid #334155; padding-bottom: 24px; margin-bottom: 24px; }
        .header-top { display: flex; justify-content: space-between; align-items: flex-start; }
        .header-right { display: flex; gap: 12px; align-items: center; }
        button { padding: 8px 16px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: all 0.3s; font-size: 14px; }
        .btn-blue { background: #2563eb; color: white; }
        .btn-blue:hover { background: #1d4ed8; }
        .btn-green { background: #16a34a; color: white; }
        .btn-green:hover { background: #15803d; }
        .btn-purple { background: #9333ea; color: white; }
        .btn-purple:hover { background: #7e22ce; }
        .capital-group { text-align: right; }
        .capital-label { font-size: 12px; color: #94a3b8; margin-bottom: 4px; }
        .capital-input { background: #475569; border: 1px solid #334155; color: white; padding: 8px 12px; border-radius: 6px; width: 120px; text-align: right; font-size: 14px; }
        .account-selector { display: flex; gap: 8px; align-items: center; margin-bottom: 16px; }
        .account-button { padding: 8px 12px; border: 2px solid #475569; border-radius: 6px; background: transparent; color: #cbd5e1; cursor: pointer; font-weight: 600; transition: all 0.3s; }
        .account-button.active { border-color: #06b6d4; background: rgba(6, 182, 212, 0.2); color: #06b6d4; }
        .account-button:hover { border-color: #06b6d4; }
        .tabs { display: flex; gap: 8px; margin-bottom: 24px; flex-wrap: wrap; }
        .tab { padding: 10px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; background: #475569; color: #cbd5e1; transition: all 0.3s; border: none; font-size: 14px; }
        .tab.active { background: linear-gradient(90deg, #3b82f6, #06b6d4); color: #0f172a; }
        .content { display: none; }
        .content.active { display: block; }
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .kpi-card { background: #334155; border: 1px solid #475569; border-radius: 8px; padding: 20px; }
        .kpi-label { color: #94a3b8; font-size: 12px; margin-bottom: 8px; text-transform: uppercase; }
        .kpi-value { font-size: 28px; font-weight: bold; margin-bottom: 4px; }
        .kpi-sub { font-size: 12px; color: #64748b; }
        .green { color: #4ade80; }
        .blue { color: #60a5fa; }
        .cyan { color: #06b6d4; }
        .red { color: #f87171; }
        .purple { color: #a78bfa; }
        .form-group { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 16px; }
        .form-input { background: #475569; border: 1px solid #334155; color: white; padding: 8px 12px; border-radius: 6px; font-size: 14px; }
        .form-input:focus { outline: none; border-color: #3b82f6; }
        .form-actions { display: flex; gap: 12px; margin-top: 16px; }
        .form-actions button { flex: 1; padding: 12px; }
        .hidden { display: none !important; }
        table { width: 100%; border-collapse: collapse; background: #334155; border-radius: 8px; overflow: hidden; margin-bottom: 24px; table-layout: fixed; }
        thead { background: #1e293b; }
        th { padding: 12px 16px; text-align: left; font-weight: 600; font-size: 13px; word-break: break-word; }
        td { padding: 12px 16px; border-bottom: 1px solid #475569; font-size: 13px; word-break: break-word; overflow-wrap: break-word; }
        tbody tr:hover { background: #3f4654; }
        td.center { text-align: center; }
        td.right { text-align: right; }
        .badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        .badge-long { background: #166534; color: #86efac; }
        .badge-short { background: #7c2d12; color: #fed7aa; }
        .section { background: #334155; border: 1px solid #475569; border-radius: 8px; padding: 16px; margin-bottom: 24px; }
        .section-title { font-size: 18px; font-weight: 600; margin-bottom: 16px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px; }
        .stat-box { background: #475569; padding: 12px; border-radius: 6px; }
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 13px; }
        .stat-label { color: #94a3b8; }
        .stat-value { font-weight: 600; }
        .trade-card { background: #334155; border: 1px solid #475569; border-radius: 8px; padding: 16px; margin-bottom: 16px; }
        .trade-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .trade-date { color: #94a3b8; font-size: 12px; }
        .trade-meta { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 12px; font-size: 13px; }
        .trade-field { display: flex; justify-content: space-between; }
        .trade-label { color: #94a3b8; }
        .trade-value { font-weight: 600; }
        .trade-comment { background: #475569; padding: 12px; border-radius: 6px; margin-top: 12px; font-size: 13px; line-height: 1.5; color: #cbd5e1; }
        .trade-result { padding: 8px 12px; border-radius: 6px; font-size: 14px; font-weight: bold; margin-top: 8px; }
        .trade-result.win { background: #166534; color: #86efac; }
        .trade-result.loss { background: #7c2d12; color: #fed7aa; }
        .trade-image { max-width: 100%; max-height: 300px; border-radius: 6px; margin-top: 12px; cursor: pointer; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.9); align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { position: relative; max-width: 90%; max-height: 90%; }
        .modal-content img { max-width: 100%; max-height: 90vh; }
        .close-modal { position: absolute; top: 20px; right: 30px; color: white; font-size: 40px; font-weight: bold; cursor: pointer; }
        .image-preview { max-width: 200px; max-height: 150px; margin-top: 8px; border-radius: 6px; }
        .chart-container { position: relative; height: 400px; margin-bottom: 30px; }
        .account-form { display: grid; grid-template-columns: 1fr 1fr auto; gap: 12px; margin-bottom: 16px; }
    </style>
</head>
<body>
    <div id="login" class="login-container">
        <div class="login-box">
            <h1>L'Art du Trading</h1>
            <p>Accès Formation ADT</p>
            <input type="password" id="passwordInput" placeholder="Mot de passe" onkeypress="if(event.key==='Enter') authenticate()">
            <button onclick="authenticate()">Accéder</button>
        </div>
    </div>

    <div id="app" class="container hidden">
        <div class="header">
            <div class="header-top">
                <div>
                    <h1>L'Art du Trading</h1>
                    <p class="subtitle">Delinvest - Track Record</p>
                </div>
                <div class="header-right">
                    <button class="btn-blue" onclick="exportData()">Export</button>
                    <button class="btn-green" onclick="document.getElementById('importFile').click()">Import</button>
                    <input type="file" accept=".json" onchange="importData(event)" style="display:none;" id="importFile">
                    <button class="btn-purple" onclick="toggleAccountManager()">⚙️ Comptes</button>
                </div>
            </div>
        </div>

        <div id="accountManager" class="section hidden">
            <div class="section-title">Gérer mes comptes</div>
            <div class="account-form">
                <input type="text" id="newAccountName" placeholder="Nom du compte" class="form-input">
                <input type="number" id="newAccountCapital" placeholder="Capital initial" class="form-input" value="10000">
                <button class="btn-green" onclick="createAccount()">Créer</button>
            </div>
            <div id="accountsList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px;"></div>
        </div>

        <div class="account-selector">
            <span style="color: #94a3b8;">Compte actif:</span>
            <div id="accountButtons"></div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab(0)">📊 Dashboard</button>
            <button class="tab" onclick="switchTab(1)">📝 Journal</button>
            <button class="tab" onclick="switchTab(2)">📊 Statistiques</button>
            <button class="tab" onclick="switchTab(3)">💬 Trades</button>
            <button class="tab" onclick="switchTab(4)">📋 Détails</button>
        </div>

        <div class="content active">
            <div class="kpi-grid">
                <div class="kpi-card"><div class="kpi-label">Performance</div><div class="kpi-value green" id="perf">0.00%</div><div class="kpi-sub" id="pnl">$0.00</div></div>
                <div class="kpi-card"><div class="kpi-label">Capital Actuel</div><div class="kpi-value blue" id="capital-display">$10000</div><div class="kpi-sub" id="equity">Init: $10000</div></div>
                <div class="kpi-card"><div class="kpi-label">Winrate</div><div class="kpi-value cyan" id="winrate">0%</div><div class="kpi-sub" id="trades-count">0/0 trades</div></div>
                <div class="kpi-card"><div class="kpi-label">Profit Factor</div><div class="kpi-value purple" id="pf">0</div><div class="kpi-sub">Gain/Loss</div></div>
                <div class="kpi-card"><div class="kpi-label">Max Drawdown</div><div class="kpi-value red" id="maxdd">0.00%</div></div>
                <div class="kpi-card"><div class="kpi-label">Sharpe Ratio</div><div class="kpi-value" style="color: #fbbf24;" id="sharpe">0.00</div><div class="kpi-sub">Risk-adjusted</div></div>
                <div class="kpi-card"><div class="kpi-label">Expectancy</div><div class="kpi-value" style="color: #34d399;" id="expectancy">$0.00</div><div class="kpi-sub">Avg/trade</div></div>
                <div class="kpi-card"><div class="kpi-label">Avg Gain</div><div class="kpi-value green" id="avggain">$0.00</div><div class="kpi-sub" id="avggain-count">-</div></div>
            </div>
        </div>

        <div class="content">
            <button class="btn-green" style="margin-bottom: 16px;" onclick="toggleForm()">+ Ajouter Trade</button>
            <div id="form" class="section hidden">
                <h3 style="margin-bottom: 16px;">Nouveau Trade</h3>
                <div class="form-group">
                    <input type="date" id="date" class="form-input">
                    <select id="asset" class="form-input"><option>NAS100</option><option>DAX40</option><option>GOLD</option><option>SPX500</option><option>EUR/USD</option><option>DJ30</option></select>
                    <select id="setup" class="form-input"><option>Delinvest Prime©</option><option>Delinvest Zone©</option></select>
                    <select id="direction" class="form-input"><option>Long</option><option>Short</option></select>
                    <input type="number" id="entry" placeholder="Entrée" class="form-input" step="0.01">
                    <input type="number" id="sl" placeholder="SL" class="form-input" step="0.01">
                    <input type="number" id="tp" placeholder="TP" class="form-input" step="0.01">
                    <div style="display: flex; gap: 8px;"><input type="number" id="result" placeholder="Résultat" class="form-input" step="0.01" style="flex: 1;"><select id="resultType" class="form-input" style="flex: 0.4;"><option>USD</option><option>Pips</option></select></div>
                    <input type="number" id="leverage" placeholder="Levier" class="form-input" value="1" step="0.1">
                    <textarea id="comment" placeholder="Commentaire..." class="form-input" style="grid-column: 1 / -1; height: 60px;"></textarea>
                </div>
                <div style="margin-bottom: 16px; padding: 12px; background: #475569; border-radius: 6px;">
                    <label style="display: block; color: #94a3b8; font-size: 12px; margin-bottom: 8px;">Screenshot du graphique (optionnel)</label>
                    <input type="file" id="screenshot" accept="image/*" class="form-input" onchange="previewScreenshot()">
                    <img id="screenshotPreview" class="image-preview" style="display:none;">
                </div>
                <div class="form-actions"><button class="btn-green" onclick="addTrade()">Ajouter</button><button class="btn-blue" onclick="toggleForm()">Annuler</button></div>
            </div>
            <table id="tradesTable"><thead><tr><th style="width: 12%;">Date</th><th style="width: 10%;">Actif</th><th style="width: 15%;">Setup</th><th style="width: 8%;" class="center">Dir</th><th style="width: 12%;" class="right">Entrée</th><th style="width: 8%;" class="right">R:R</th><th style="width: 12%;" class="right">Résultat</th><th style="width: 8%;" class="center">Actions</th></tr></thead><tbody id="tradesBody"></tbody></table>
        </div>

        <div class="content">
            <div class="section">
                <div class="section-title">Equity Curve</div>
                <div class="chart-container">
                    <canvas id="equityCurveChart"></canvas>
                </div>
            </div>
            <div class="section">
                <div class="section-title">Balance Over Time</div>
                <div class="chart-container">
                    <canvas id="balanceChart"></canvas>
                </div>
            </div>
        </div>

        <div class="content">
            <h2 style="margin-bottom: 24px; font-size: 24px;">Analyse des Trades</h2>
            <div id="tradesComments"></div>
        </div>

        <div class="content">
            <div class="section">
                <div class="section-title">Statistiques Avancées</div>
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-row"><span class="stat-label">Avg Gain</span><span class="stat-value green" id="detail-avggain">$0</span></div>
                        <div class="stat-row"><span class="stat-label">Avg Loss</span><span class="stat-value red" id="detail-avgloss">$0</span></div>
                        <div class="stat-row"><span class="stat-label">Ratio</span><span class="stat-value blue" id="detail-ratio">0</span></div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-row"><span class="stat-label">Total</span><span class="stat-value cyan" id="detail-total">0</span></div>
                        <div class="stat-row"><span class="stat-label">Wins</span><span class="stat-value green" id="detail-wins">0</span></div>
                        <div class="stat-row"><span class="stat-label">Losses</span><span class="stat-value red" id="detail-losses">0</span></div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-row"><span class="stat-label">Levier</span><span class="stat-value purple" id="detail-leverage">0x</span></div>
                        <div class="stat-row"><span class="stat-label">R:R Moy</span><span class="stat-value blue" id="detail-rr">0</span></div>
                        <div class="stat-row"><span class="stat-label">Volatilité</span><span class="stat-value" style="color: #fbbf24;" id="detail-vol">$0</span></div>
                    </div>
                </div>
            </div>
            <div class="section">
                <div class="section-title">Performance & Actif</div>
                <div id="assetStats"></div>
            </div>
        </div>
    </div>

    <div id="imageModal" class="modal" onclick="closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <span class="close-modal" onclick="closeModal()">&times;</span>
            <img id="modalImage" src="">
        </div>
    </div>

    <script>
        function authenticate() {
            const pwd = document.getElementById('passwordInput').value;
            if (pwd === 'ADT1.0') {
                sessionStorage.setItem('authenticated', 'true');
                document.getElementById('login').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
                initializeAccounts();
            } else {
                alert('Mot de passe incorrect');
                document.getElementById('passwordInput').value = '';
            }
        }

        if (!sessionStorage.getItem('authenticated')) {
            document.getElementById('app').classList.add('hidden');
        } else {
            document.getElementById('login').classList.add('hidden');
        }

        let accounts = {};
        let currentAccount = 'default';
        let trades = [];
        let currentScreenshot = null;
        let equityCurveChart = null;
        let balanceChart = null;

        function initializeAccounts() {
            const saved = localStorage.getItem('tradingAccounts');
            if (saved) {
                accounts = JSON.parse(saved);
                if (!accounts[currentAccount]) currentAccount = Object.keys(accounts)[0] || 'default';
            } else {
                accounts = { 'default': { name: 'Compte Principal', capital: 10000, trades: [] } };
            }
            loadCurrentAccount();
            updateAccountButtons();
        }

        function loadCurrentAccount() {
            const account = accounts[currentAccount];
            trades = account.trades || [];
            document.querySelectorAll('.account-button').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-account="${currentAccount}"]`)?.classList.add('active');
            updateUI();
        }

        function saveAccounts() {
            const account = accounts[currentAccount];
            account.trades = trades;
            localStorage.setItem('tradingAccounts', JSON.stringify(accounts));
        }

        function createAccount() {
            const name = document.getElementById('newAccountName').value;
            const capital = parseFloat(document.getElementById('newAccountCapital').value);
            if (!name || !capital) { alert('Remplissez tous les champs'); return; }
            const id = 'account_' + Date.now();
            accounts[id] = { name, capital, trades: [] };
            document.getElementById('newAccountName').value = '';
            document.getElementById('newAccountCapital').value = '10000';
            saveAccounts();
            updateAccountButtons();
        }

        function switchAccount(id) {
            saveAccounts();
            currentAccount = id;
            loadCurrentAccount();
        }

        function deleteAccount(id) {
            if (Object.keys(accounts).length === 1) { alert('Vous devez garder au moins un compte'); return; }
            if (confirm('Êtes-vous sûr de vouloir supprimer ce compte ?')) {
                delete accounts[id];
                saveAccounts();
                currentAccount = Object.keys(accounts)[0];
                loadCurrentAccount();
                updateAccountButtons();
            }
        }

        function updateAccountButtons() {
            const container = document.getElementById('accountButtons');
            container.innerHTML = '';
            Object.entries(accounts).forEach(([id, account]) => {
                const btn = document.createElement('button');
                btn.className = 'account-button' + (id === currentAccount ? ' active' : '');
                btn.setAttribute('data-account', id);
                btn.innerHTML = `${account.name} ($${account.capital.toLocaleString()})`;
                btn.onclick = () => switchAccount(id);
                container.appendChild(btn);
            });
        }

        function toggleAccountManager() {
            document.getElementById('accountManager').classList.toggle('hidden');
            const list = document.getElementById('accountsList');
            list.innerHTML = '';
            Object.entries(accounts).forEach(([id, account]) => {
                const div = document.createElement('div');
                div.style.cssText = 'background: #475569; padding: 12px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center;';
                div.innerHTML = `<div><strong>${account.name}</strong><br><span style="font-size: 12px; color: #94a3b8;">$${account.capital.toLocaleString()} - ${account.trades.length} trades</span></div>`;
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = '✕';
                deleteBtn.style.cssText = 'background: #dc2626; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer;';
                deleteBtn.onclick = () => deleteAccount(id);
                div.appendChild(deleteBtn);
                list.appendChild(div);
            });
        }

        function previewScreenshot() {
            const file = document.getElementById('screenshot').files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    currentScreenshot = e.target.result;
                    const preview = document.getElementById('screenshotPreview');
                    preview.src = currentScreenshot;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        }

        function setDate() { document.getElementById('date').valueAsDate = new Date(); }
        function calculateRR(entry, sl, tp, dir) {
            if (!entry || !sl || !tp) return 0;
            const e = parseFloat(entry), s = parseFloat(sl), t = parseFloat(tp);
            if (dir === 'Long') {
                const risk = e - s, reward = t - e;
                return risk > 0 ? (reward / risk).toFixed(2) : 0;
            } else {
                const risk = s - e, reward = e - t;
                return risk > 0 ? (reward / risk).toFixed(2) : 0;
            }
        }
        function addTrade() {
            const entry = parseFloat(document.getElementById('entry').value);
            const sl = parseFloat(document.getElementById('sl').value);
            const tp = parseFloat(document.getElementById('tp').value);
            const result = parseFloat(document.getElementById('result').value);
            if (!entry || !sl || !tp || !result) { alert('Remplissez tous les champs'); return; }
            const resultUSD = document.getElementById('resultType').value === 'USD' ? result : result * 10;
            const trade = {
                id: Date.now(),
                date: document.getElementById('date').value,
                asset: document.getElementById('asset').value,
                setup: document.getElementById('setup').value,
                direction: document.getElementById('direction').value,
                entry: entry.toFixed(2),
                sl: sl.toFixed(2),
                tp: tp.toFixed(2),
                rr: calculateRR(entry, sl, tp, document.getElementById('direction').value),
                resultUSD: resultUSD.toFixed(2),
                leverage: parseFloat(document.getElementById('leverage').value),
                comment: document.getElementById('comment').value || '-',
                screenshot: currentScreenshot
            };
            trades.push(trade);
            document.getElementById('entry').value = '';
            document.getElementById('sl').value = '';
            document.getElementById('tp').value = '';
            document.getElementById('result').value = '';
            document.getElementById('comment').value = '';
            document.getElementById('screenshot').value = '';
            document.getElementById('screenshotPreview').style.display = 'none';
            currentScreenshot = null;
            saveAccounts();
            updateUI();
            toggleForm();
        }
        function deleteTrade(id) { trades = trades.filter(t => t.id !== id); saveAccounts(); updateUI(); }
        function updateTradesTable() {
            const tbody = document.getElementById('tradesBody');
            tbody.innerHTML = '';
            if (trades.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 24px; color: #94a3b8;">Aucun trade</td></tr>';
                return;
            }
            trades.slice().reverse().forEach(t => {
                const row = document.createElement('tr');
                row.innerHTML = `<td>${t.date}</td><td>${t.asset}</td><td>${t.setup}</td><td class="center"><span class="badge ${t.direction === 'Long' ? 'badge-long' : 'badge-short'}">${t.direction[0]}</span></td><td class="right">${t.entry}</td><td class="right" style="color: #60a5fa; font-weight: bold;">${t.rr}</td><td class="right" style="color: ${parseFloat(t.resultUSD) > 0 ? '#4ade80' : '#f87171'}; font-weight: bold;">$${t.resultUSD}</td><td class="center"><button onclick="deleteTrade(${t.id}); updateUI();" style="background: #dc2626; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;">×</button></td>`;
                tbody.appendChild(row);
            });
        }
        function updateTradesComments() {
            const container = document.getElementById('tradesComments');
            if (trades.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #94a3b8; padding: 40px;">Aucun trade pour le moment</div>';
                return;
            }
            let html = '';
            trades.slice().reverse().forEach(t => {
                const isWin = parseFloat(t.resultUSD) > 0;
                let imageHtml = '';
                if (t.screenshot) {
                    imageHtml = `<img class="trade-image" src="${t.screenshot}" onclick="openModal('${t.screenshot}')">`;
                }
                html += `<div class="trade-card"><div class="trade-header"><div><strong>${t.asset}</strong> • ${t.setup}<div class="trade-date">${t.date}</div></div><span class="badge ${t.direction === 'Long' ? 'badge-long' : 'badge-short'}">${t.direction}</span></div><div class="trade-meta"><div class="trade-field"><span class="trade-label">Entrée</span><span class="trade-value">${t.entry}</span></div><div class="trade-field"><span class="trade-label">SL</span><span class="trade-value">${t.sl}</span></div><div class="trade-field"><span class="trade-label">TP</span><span class="trade-value">${t.tp}</span></div><div class="trade-field"><span class="trade-label">R:R</span><span class="trade-value" style="color: #60a5fa;">${t.rr}</span></div></div><div class="trade-result ${isWin ? 'win' : 'loss'}">${isWin ? '✓' : '✗'} ${isWin ? '+' : ''}$${t.resultUSD}</div><div class="trade-comment">💬 ${t.comment}</div>${imageHtml}</div>`;
            });
            container.innerHTML = html;
        }
        function updateEquityCurve() {
            const capital = accounts[currentAccount].capital;
            const labels = [];
            const equityData = [];
            const balanceData = [];
            let runningEquity = capital;
            trades.slice().sort((a, b) => new Date(a.date) - new Date(b.date)).forEach(t => {
                runningEquity += parseFloat(t.resultUSD);
                labels.push(t.date);
                equityData.push(runningEquity);
                balanceData.push(parseFloat(t.resultUSD));
            });
            if (equityData.length === 0) {
                equityData.push(capital);
                balanceData.push(0);
                labels.push('Aucun trade');
            }
            const ctx1 = document.getElementById('equityCurveChart');
            if (ctx1) {
                if (equityCurveChart) equityCurveChart.destroy();
                equityCurveChart = new Chart(ctx1, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Capital Total',
                            data: equityData,
                            borderColor: '#06b6d4',
                            backgroundColor: 'rgba(6, 182, 212, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 4,
                            pointBackgroundColor: '#06b6d4'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { labels: { color: '#cbd5e1' } }
                        },
                        scales: {
                            y: { ticks: { color: '#94a3b8' }, grid: { color: '#334155' } },
                            x: { ticks: { color: '#94a3b8' }, grid: { color: '#334155' } }
                        }
                    }
                });
            }
            const ctx2 = document.getElementById('balanceChart');
            if (ctx2) {
                if (balanceChart) balanceChart.destroy();
                balanceChart = new Chart(ctx2, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'P&L par Trade',
                            data: balanceData,
                            backgroundColor: balanceData.map(val => val > 0 ? '#4ade80' : '#f87171'),
                            borderColor: balanceData.map(val => val > 0 ? '#22c55e' : '#dc2626'),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { labels: { color: '#cbd5e1' } }
                        },
                        scales: {
                            y: { ticks: { color: '#94a3b8' }, grid: { color: '#334155' } },
                            x: { ticks: { color: '#94a3b8' }, grid: { color: '#334155' } }
                        }
                    }
                });
            }
        }
        function updateUI() {
            const capital = accounts[currentAccount].capital;
            const totalPnL = trades.reduce((sum, t) => sum + parseFloat(t.resultUSD), 0);
            const totalTrades = trades.length;
            const winTrades = trades.filter(t => parseFloat(t.resultUSD) > 0).length;
            const lossTrades = totalTrades - winTrades;
            const winRate = totalTrades > 0 ? ((winTrades / totalTrades) * 100).toFixed(2) : 0;
            const avgGain = winTrades > 0 ? (trades.filter(t => parseFloat(t.resultUSD) > 0).reduce((sum, t) => sum + parseFloat(t.resultUSD), 0) / winTrades).toFixed(2) : 0;
            const avgLoss = lossTrades > 0 ? (Math.abs(trades.filter(t => parseFloat(t.resultUSD) < 0).reduce((sum, t) => sum + parseFloat(t.resultUSD), 0)) / lossTrades).toFixed(2) : 0;
            const pf = avgLoss > 0 ? (avgGain / avgLoss).toFixed(2) : 0;
            const expectancy = (parseFloat(winRate) / 100 * parseFloat(avgGain)) - ((1 - parseFloat(winRate) / 100) * parseFloat(avgLoss));
            let runCap = capital, maxCap = capital, maxDD = 0;
            trades.forEach(t => {
                runCap += parseFloat(t.resultUSD);
                maxCap = Math.max(maxCap, runCap);
                const dd = ((maxCap - runCap) / maxCap) * 100;
                maxDD = Math.max(maxDD, dd);
            });
            const tradesByDate = {};
            trades.forEach(t => {
                if (!tradesByDate[t.date]) tradesByDate[t.date] = 0;
                tradesByDate[t.date] += parseFloat(t.resultUSD);
            });
            const dailyPnL = Object.values(tradesByDate);
            const avgDaily = dailyPnL.length > 0 ? dailyPnL.reduce((a, b) => a + b) / dailyPnL.length : 0;
            const stdDev = dailyPnL.length > 0 ? Math.sqrt(dailyPnL.reduce((sum, val) => sum + Math.pow(val - avgDaily, 2), 0) / dailyPnL.length) : 1;
            const sharpe = stdDev > 0 ? (avgDaily / stdDev * Math.sqrt(252)).toFixed(2) : 0;
            const currentEq = capital + totalPnL;
            const perfPct = ((totalPnL / capital) * 100).toFixed(2);
            document.getElementById('perf').textContent = perfPct + '%';
            document.getElementById('pnl').textContent = '$' + totalPnL.toFixed(2);
            document.getElementById('capital-display').textContent = '$' + currentEq.toFixed(0);
            document.getElementById('equity').textContent = 'Init: $' + capital;
            document.getElementById('winrate').textContent = winRate + '%';
            document.getElementById('trades-count').textContent = winTrades + '/' + totalTrades + ' trades';
            document.getElementById('pf').textContent = pf;
            document.getElementById('maxdd').textContent = maxDD.toFixed(2) + '%';
            document.getElementById('sharpe').textContent = sharpe;
            document.getElementById('expectancy').textContent = '$' + expectancy.toFixed(2);
            document.getElementById('avggain').textContent = '$' + avgGain;
            document.getElementById('avggain-count').textContent = winTrades + ' wins';
            document.getElementById('detail-avggain').textContent = '$' + avgGain;
            document.getElementById('detail-avgloss').textContent = '-$' + avgLoss;
            document.getElementById('detail-ratio').textContent = (avgLoss > 0 ? (avgGain / avgLoss) : 0).toFixed(2);
            document.getElementById('detail-total').textContent = totalTrades;
            document.getElementById('detail-wins').textContent = winTrades;
            document.getElementById('detail-losses').textContent = lossTrades;
            document.getElementById('detail-leverage').textContent = (trades.reduce((sum, t) => sum + parseFloat(t.leverage), 0) / (totalTrades || 1)).toFixed(1) + 'x';
            document.getElementById('detail-rr').textContent = (trades.reduce((sum, t) => sum + parseFloat(t.rr), 0) / (totalTrades || 1)).toFixed(2);
            if (stdDev === 0 || isNaN(stdDev) || !isFinite(stdDev)) { document.getElementById('detail-vol').textContent = '$0.00'; } else { document.getElementById('detail-vol').textContent = '$' + stdDev.toFixed(2); }
            updateTradesTable();
            updateTradesComments();
            updateStats();
            updateEquityCurve();
        }
        function updateStats() {
            const byAsset = {};
            trades.forEach(t => {
                if (!byAsset[t.asset]) byAsset[t.asset] = {wins: 0, total: 0, pnl: 0};
                byAsset[t.asset].total++; if (parseFloat(t.resultUSD) > 0) byAsset[t.asset].wins++; byAsset[t.asset].pnl += parseFloat(t.resultUSD);
            });
            let html = '<div class="stats-grid">';
            Object.entries(byAsset).forEach(([asset, stats]) => {
                html += `<div class="stat-box"><div class="stat-row"><span class="stat-label">${asset}</span><span class="stat-value">${stats.total}</span></div><div class="stat-row"><span class="stat-label">WR</span><span class="stat-value cyan">${((stats.wins/stats.total)*100).toFixed(0)}%</span></div><div class="stat-row"><span class="stat-label">PnL</span><span class="stat-value" style="color: ${stats.pnl > 0 ? '#4ade80' : '#f87171'}">$${stats.pnl.toFixed(0)}</span></div></div>`;
            });
            html += '</div>';
            document.getElementById('assetStats').innerHTML = html;
        }
        function toggleForm() {
            document.getElementById('form').classList.toggle('hidden');
            if (!document.getElementById('form').classList.contains('hidden')) setDate();
        }
        function switchTab(idx) {
            document.querySelectorAll('.content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.content')[idx].classList.add('active');
            document.querySelectorAll('.tab')[idx].classList.add('active');
        }
        function openModal(imageSrc) {
            document.getElementById('modalImage').src = imageSrc;
            document.getElementById('imageModal').classList.add('active');
        }
        function closeModal() {
            document.getElementById('imageModal').classList.remove('active');
        }
        function exportData() {
            const data = accounts;
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'track-record-all.json';
            a.click();
            URL.revokeObjectURL(url);
        }
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    accounts = data;
                    currentAccount = Object.keys(accounts)[0] || 'default';
                    localStorage.setItem('tradingAccounts', JSON.stringify(accounts));
                    loadCurrentAccount();
                    updateAccountButtons();
                    alert('Données importées avec succès !');
                } catch (err) {
                    alert('Erreur lors de l\'import : ' + err.message);
                }
            };
            reader.readAsText(file);
        }
    </script>
</body>
</html>
